<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="conductorUnidad">
    
    <!-- ====================================================== -->
    <!-- ASIGNAR UNIDAD A CONDUCTOR                             -->
    <!-- ====================================================== -->
    <insert id="asignar" parameterType="pojo.ConductorUnidad">
        INSERT INTO ConductorUnidad (
        idColaborador,
        idUnidad,
        fechaAsignacion,
        activo
        ) VALUES (
        #{idColaborador},
        #{idUnidad},
        NOW(),
        1
        )
    </insert>


    <!-- ====================================================== -->
    <!-- DESASIGNAR POR ID                                      -->
    <!-- ====================================================== -->
    <update id="desasignar-por-id" parameterType="int">
        UPDATE ConductorUnidad
        SET activo = 0,
        fechaDesasignacion = NOW()
        WHERE idConductorUnidad = #{idConductorUnidad}
        AND activo = 1
    </update>

    <!-- ====================================================== -->
    <!-- DESASIGNAR POR CONDUCTOR                               -->
    <!-- ====================================================== -->
    <update id="desasignar-por-conductor" parameterType="int">
        UPDATE ConductorUnidad
        SET activo = 0,
        fechaDesasignacion = NOW()
        WHERE idColaborador = #{idColaborador}
        AND activo = 1
    </update>


    <!-- ====================================================== -->
    <!-- DESASIGNAR POR UNIDAD                                  -->
    <!-- ====================================================== -->
    <update id="desasignar-por-unidad" parameterType="int">
        UPDATE ConductorUnidad
        SET activo = 0,
        fechaDesasignacion = NOW()
        WHERE idUnidad = #{idUnidad}
        AND activo = 1
    </update>


    <!-- ====================================================== -->
    <!-- UNIDAD ACTUAL CONDUCTOR                                -->
    <!-- ====================================================== -->
    <select id="unidad-actual-conductor"
            parameterType="int"
            resultType="pojo.ConductorUnidad">
        SELECT *
        FROM ConductorUnidad
        WHERE idColaborador = #{idColaborador}
        AND activo = 1
        LIMIT 1
    </select>


    <!-- ====================================================== -->
    <!-- CONDUCTOR ACTUAL UNIDAD                                -->
    <!-- ====================================================== -->
    <select id="conductor-actual-unidad"
            parameterType="int"
            resultType="pojo.ConductorUnidad">
        SELECT *
        FROM ConductorUnidad
        WHERE idUnidad = #{idUnidad}
        AND activo = 1
        LIMIT 1
    </select>


    <!-- ====================================================== -->
    <!-- HISTORIALES                                            -->
    <!-- ====================================================== -->
    <select id="historial-por-conductor"
            parameterType="int"
            resultType="pojo.ConductorUnidad">
        SELECT *
        FROM ConductorUnidad
        WHERE idColaborador = #{idColaborador}
        ORDER BY fechaAsignacion DESC
    </select>

    <select id="historial-por-unidad"
            parameterType="int"
            resultType="pojo.ConductorUnidad">
        SELECT *
        FROM ConductorUnidad
        WHERE idUnidad = #{idUnidad}
        ORDER BY fechaAsignacion DESC
    </select>


    <!-- ====================================================== -->
    <!-- CONDUCTORES (TODOS)                                    -->
    <!-- ====================================================== -->
    <select id="conductores"
            resultType="pojo.Colaborador">
        SELECT  
        c.idColaborador, 
        c.nombre, 
        c.apellidoPaterno, 
        c.apellidoMaterno, 
        c.noPersonal, 
        c.numeroLicencia 
        FROM Colaborador c 
        INNER JOIN Rol r ON c.idRol = r.idRol 
        WHERE r.nombre = 'Conductor' 
    </select> 


    <!-- ====================================================== -->
    <!-- UNIDADES ACTIVAS                                       -->
    <!-- ====================================================== -->
    <select id="unidades-activas"
            resultType="pojo.Unidad">
        SELECT *
        FROM Unidad
        WHERE estatus = 'Activa'
    </select>
</mapper>
